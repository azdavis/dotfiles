#!/bin/sh -eu

. "$HOME/.config/lib/panic.sh"

if [ $# -ne 0 ]; then
    panic "usage: $(basename "$0")"
fi

cd "$HOME/.config"

p="$PWD/theme/dark.patch"
iterm_profile=""
git_direction=""
macos_dark=false
if git apply --check "$p" 2>/dev/null; then
    iterm_profile="dark"
    git_direction=""
    macos_dark=true
elif git apply --check --reverse "$p" 2>/dev/null; then
    iterm_profile="light"
    git_direction="--reverse"
    macos_dark=false
else
    panic "'$p' does not apply in either direction"
fi

git apply $git_direction "$p"
printf "\033]50;SetProfile=$iterm_profile\a"
if [ "$(uname)" = Darwin ]; then
    osascript -l JavaScript -e "
    Application('System Events').appearancePreferences.darkMode = $macos_dark
    " >/dev/null
fi
