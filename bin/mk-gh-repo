#!/bin/sh

set -eu
. "$HOME/.config/lib/get_github_cred.sh"
. "$HOME/.config/lib/panic.sh"

show_help() {
cat <<EOS
usage: $(basename "$0") [options]

options:
	-d <desc>
		use the repo description <desc>
	-h
		show this help
	-n <name>
		use the repo name <name>
	-p
		make the repo private
	-v
		explain what is being done
EOS
}

usage() {
	show_help 1>&2
	exit 1
}

d=""
n="$(basename "$PWD")"
p=false
v=false
while getopts "d:hn:pv" opt; do
	case "$opt" in
	(d) d="$OPTARG" ;;
	(n) n="$OPTARG" ;;
	(p) p=true ;;
	(v) v=true ;;
	(*) usage ;;
	esac
done
shift $((OPTIND - 1))

if [ $# -ne 0 ]; then
	usage
fi

git rev-parse

note() {
	if $v; then
		echo "$1"
	fi
}

github_name="$(get_github_cred username)"
github_password="$(get_github_cred password)"

# there must be spaces surrounding { and } in the json data
# e761df8a36c4e302ebda8b792f70d631b0e8452d
url="https://github.com/$github_name/$n.git"
note "creating '$url'"
git remote add origin "$url"
if [ \
	"$(curl \
		-H "Accept: application/vnd.github.v3+json" \
		-H "Content-Type: application/json" \
		-H "Authorization: token $github_password" \
		-X POST \
		-d " { \"name\":\"$n\", \"description\":\"$d\", \"private\":$p } " \
		-s \
		-o /dev/null \
		-w "%{http_code}" \
		"https://api.github.com/user/repos" \
	)" -ne 201 \
]; then
	panic "could not create"
fi
if $v; then
	git push -u origin master
else
	git push -q -u origin master > /dev/null
fi
