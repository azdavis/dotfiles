#!/bin/sh

set -eu
. "$XDG_CONFIG_HOME/lib/abort.sh"

if [ $# -ne 0 ]; then
	abort "usage: $(basename "$0")"
fi

cd "$XDG_CONFIG_HOME"

old_om="$(git rev-parse origin/master)"
if [ \
	"$(curl \
		-H "Accept: application/vnd.github.chitauri-preview+sha" \
		-H "If-None-Match: \"$old_om\"" \
		-s \
		-o /dev/null \
		-w "%{http_code}" \
		"https://api.github.com/repos/azdavis/dotfiles/commits/master" \
	)" -ne 304 \
]; then
	git fetch -q origin master
fi

if git merge-base --is-ancestor origin/master @; then
	echo "already up-to-date"
	exit
fi

if ! git rebase --onto origin/master "$old_om"; then
	abort "go to '$XDG_CONFIG_HOME' to resolve this error"
fi

"$XDG_CONFIG_HOME/bin/do-home"
