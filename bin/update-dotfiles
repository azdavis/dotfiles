#!/bin/sh

. "$HOME/.config/lib/base.sh"
. "$HOME/.config/lib/abort.sh"

cd "$HOME/.config"

lock="update-dotfiles.lock"
if ! ln -s $$ "$lock" >/dev/null 2>&1; then
    if kill -0 "$(readlink "$lock")"; then
        abort "there is another instance of update-dotfiles running"
    fi
    ln -sf $$ "$lock"
fi
trap "rm \"$lock\"" EXIT

if ! ping -c 1 github.com >/dev/null 2>&1; then
    abort "cannot connect to github.com"
elif ! git diff-index --quiet master; then
    abort "there are uncommited changes"
elif [ "$(curl \
    "https://api.github.com/repos/azdavis/dotfiles/commits/master" \
    -H "Accept: application/vnd.github.chitauri-preview+sha" \
    -H "If-None-Match: \"$(git rev-parse master)\"" \
    -s -o /dev/null -w "%{http_code}")" -ne 304 \
]; then
    trap "" 2
    git pull -q --rebase -X theirs origin master
fi

date +%s > update-dotfiles.last
