#!/bin/sh -eu

. ~/.config/lib/panic.sh

if [ $# -ne 0 ]; then
	panic "usage: $(basename "$0")"
fi

cd ~/.config

if [ \
	"$(curl \
		-H "Accept: application/vnd.github.chitauri-preview+sha" \
		-H "If-None-Match: \"$(git rev-parse origin/master)\"" \
		-s \
		-o /dev/null \
		-w "%{http_code}" \
		"https://api.github.com/repos/azdavis/dotfiles/commits/master" \
	)" -ne 304 \
]; then
	git fetch -q origin master
fi

if git merge-base --is-ancestor origin/master HEAD; then
	echo "already up-to-date"
elif ! git rebase -q origin/master; then
	panic "cd to '$PWD' to resolve this error"
else
	~/.config/bin/do-home
	echo "updated"
fi

git log -1 --format='%h (%cr) %s' origin/master
