#!/bin/sh

. "$HOME/.config/lib/_base.sh"

if [ $# -ne 0 ]; then
    abort "usage: $(basename "$0")"
fi

cd "$HOME/.config"

last="update-dotfiles.last"
rm -rf "$last"
date +%s > "$last"

old_om="$(git rev-parse origin/master)"
if [ \
    "$(curl \
        -H "Accept: application/vnd.github.chitauri-preview+sha" \
        -H "If-None-Match: \"$old_om\"" \
        -s \
        -o /dev/null \
        -w "%{http_code}" \
        "https://api.github.com/repos/azdavis/dotfiles/commits/master" \
    )" -ne 304 \
]; then
    git fetch -q origin master
fi

if git status -unormal --porcelain | grep -q .; then
    git stash save -q -u
    trap 'git stash pop -q --index' EXIT
fi

if git merge-base --is-ancestor origin/master @; then
    echo "already up-to-date"
    exit
fi

old_head="$(git rev-parse --short @)"
git rebase -q -X theirs --onto origin/master "$old_om" > /dev/null
new_head="$(git rev-parse --short @)"
echo "updated from $old_head to $new_head"
do-home
