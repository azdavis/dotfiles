#!/bin/sh

set -eu

panic() {
	echo "$1" >&2
	exit 1
}

if [ "$#" -ne 0 ]; then
	panic "usage: $0"
fi

cd "$HOME/.config"

old_merge_base="$(git merge-base origin/master HEAD)"
if [ \
	"$(curl \
		-H "Accept: application/vnd.github.v3.sha" \
		-H "If-None-Match: \"$(git rev-parse origin/master)\"" \
		-s \
		-o /dev/null \
		-w "%{http_code}" \
		"https://api.github.com/repos/azdavis/dotfiles/commits/master" \
	)" -ne 304 \
]; then
	git fetch -q origin master
fi

if git merge-base --is-ancestor origin/master HEAD; then
	echo "Already up-to-date"
elif git rebase -q origin/master; then
	echo "Updated"
	git log -1 --format="Was: %h (%cr) %s" "$old_merge_base"
else
	panic "cd to '$PWD' to resolve this error"
fi

git log -1 --format="Now: %h (%cr) %s" origin/master
