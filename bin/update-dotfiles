#!/bin/sh

. "$HOME/.config/lib/base.sh"
. "$HOME/.config/lib/abort.sh"

cd "$HOME/.config"

lock="update-dotfiles.lock"
if [ ! -L "$lock" ]; then
    rm -rf "$lock"
fi
if ! ln -s $$ "$lock" >/dev/null 2>&1; then
    if kill -0 "$(readlink "$lock")"; then
        abort "there is another instance of update-dotfiles running"
    fi
    rm -rf "$lock"
    ln -s $$ "$lock"
fi
trap "rm -rf '$lock'" EXIT

last="update-dotfiles.last"
rm -rf "$last"
date +%s > "$last"

if ! ping -c 1 github.com >/dev/null 2>&1; then
    abort "cannot connect to github.com"
elif [ -n "$(git status --porcelain | head -n 1)" ]; then
    abort "there are uncommited changes"
fi

cur_om="$(git rev-parse origin/master)"
if [ "$(curl \
    "https://api.github.com/repos/azdavis/dotfiles/commits/master" \
    -H "Accept: application/vnd.github.chitauri-preview+sha" \
    -H "If-None-Match: \"$cur_om\"" \
    -s -o /dev/null -w "%{http_code}")" -ne 304 \
]; then
    git fetch -q origin master
fi

cur_m="$(git rev-parse --short master)"
git rebase -q -X theirs --onto origin/master "$cur_om" master >/dev/null
new_m="$(git rev-parse --short master)"
if [ "$cur_m" = "$new_m" ]; then
    echo "already up-to-date"
else
    echo "updated dotfiles from $cur_m to $new_m"
fi
