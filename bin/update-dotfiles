#!/bin/sh

set -eu
. "$HOME/.config/lib/abort.sh"

cd "$HOME/.config"

lock="update-dotfiles.lock"
if ! [ -L "$lock" ]; then
    rm -rf "$lock"
fi
if ! ln -s $$ "$lock" > /dev/null 2>&1; then
    if kill -0 "$(readlink "$lock")"; then
        abort "there is another instance of update-dotfiles running"
    fi
    rm -rf "$lock"
    ln -s $$ "$lock"
fi
trap "rm -rf '$lock'" EXIT

last="update-dotfiles.last"
rm -rf "$last"
date +%s > "$last"

old_om="$(git rev-parse origin/master)"
if [ "$(curl \
    -H "Accept: application/vnd.github.chitauri-preview+sha" \
    -H "If-None-Match: \"$old_om\"" \
    -s \
    -o /dev/null \
    -w "%{http_code}" \
    "https://api.github.com/repos/azdavis/dotfiles/commits/master" \
    )" -ne 304 \
]; then
    git fetch -q origin master
fi

if [ "$(git status -unormal --porcelain | wc -l)" -ne 0 ]; then
    echo "auto-commiting changes"
    git add -A
    git commit -q -m "update-dotfiles auto-commit"
fi

if git merge-base --is-ancestor origin/master @; then
    echo "already up-to-date"
    exit
fi

old_head="$(git rev-parse --short @)"
git rebase -q -X theirs --onto origin/master "$old_om" > /dev/null
new_head="$(git rev-parse --short @)"
echo "updated from $old_head to $new_head"
