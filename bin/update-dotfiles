#!/bin/sh

set -eu

panic() {
	echo "$1" >&2
	exit 1
}

if [ "$#" -ne 0 ]; then
	panic "usage: $0"
fi

cd "$HOME/.config"

git rev-parse

if git status -unormal --porcelain | grep .; then
	panic "fatal: there are uncommitted changes"
fi

branch="$(git symbolic-ref HEAD)"
if [ "$branch" != refs/heads/master ]; then
	panic "fatal: not on master"
fi

old_merge_base="$(git merge-base refs/remotes/origin/master HEAD)"
if [ \
	"$(curl \
		-H "Accept: application/vnd.github.v3.sha" \
		-H "If-None-Match: \"$(git rev-parse refs/remotes/origin/master)\"" \
		-s \
		-o /dev/null \
		-w "%{http_code}" \
		"https://api.github.com/repos/azdavis/dotfiles/commits/master" \
	)" -ne 304 \
]; then
	git fetch -q origin refs/heads/master:refs/remotes/origin/master
fi

if git merge-base --is-ancestor refs/remotes/origin/master HEAD; then
	echo "Already up-to-date"
else
	git rebase -q refs/remotes/origin/master
	echo "Updated"
	git log -1 --format="Was: %h (%cr) %s" "$old_merge_base"
fi

git log -1 --format="Now: %h (%cr) %s" refs/remotes/origin/master
