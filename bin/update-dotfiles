#!/bin/sh -eu

. "$HOME/.config/lib/panic.sh"

if [ $# -ne 0 ]; then
	panic "usage: $(basename "$0")"
fi

cd "$HOME/.config"

if [ \
	"$(curl \
		-H "Accept: application/vnd.github.chitauri-preview+sha" \
		-H "If-None-Match: \"$(git rev-parse origin/master)\"" \
		-s \
		-o /dev/null \
		-w "%{http_code}" \
		"https://api.github.com/repos/azdavis/dotfiles/commits/master" \
	)" -ne 304 \
]; then
	git fetch -q origin master
fi

msg=""
if git merge-base --is-ancestor origin/master HEAD; then
	msg="already at"
elif git rebase -q origin/master; then
	"$HOME/.config/bin/do-home"
	msg="updated to"
else
	panic "cd to '$PWD' to resolve this error"
fi

git log -1 --format="$msg: %h (%cr) %s" origin/master
