#!/bin/sh

. "$HOME/.config/lib/_base.sh"

if [ $# -ne 0 ]; then
    abort "usage: $(basename "$0")"
fi

formula="$(brew --repo)/Library/Taps/homebrew/homebrew-core/Formula"
wd="$HOME/.config/pkg"

echo "doing brew"
brew update
cd "$formula"
git apply "$wd/patch"/*
cd "$wd"
checkout() {
    cd "$formula"
    git checkout .
    cd "$wd"
}
trap checkout 0
brew bundle --verbose
brew bundle cleanup --force
brew upgrade
brew cask cleanup
brew cleanup
brew prune
brew doctor

echo "doing tlmgr"
tlmgr update --self
tlmgr update --all
cat tlmgrfile | xargs tlmgr install

echo "doing npm"
npm update -g
rm -rf "$HOME/.npm"
