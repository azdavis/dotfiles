#!/bin/sh -eu

. "$HOME/.config/lib/cmd_found.sh"
. "$HOME/.config/lib/panic.sh"

if [ $# -gt 1 ]; then
	panic "usage: $(basename "$0") [<pkg-mgr>]"
fi

do_brew() {
	brew update
	brew bundle --verbose --global
	brew bundle cleanup --force --global
	brew upgrade
	brew unlink coreutils >/dev/null
	brew cask cleanup
	brew cleanup
	brew prune
}

do_npm() {
	npm update -g npm
	for x in "$(npm config get prefix)/lib/node_modules"/*; do
		if [ "$x" != npm ]; then
			npm update -g "$x"
		fi
	done
}

do_tlmgr() {
	tlmgr update --self
	tlmgr update --all
}

try() {
	if ! cmd_found "$1"; then
		echo "'$1' not found"
		return
	fi
	echo "doing '$1'"
	case "$1" in
	(brew) do_brew ;;
	(npm) do_npm ;;
	(tlmgr) do_tlmgr ;;
	(*) panic "unknown package manager '$1'" ;;
	esac
}

if [ $# -eq 1 ]; then
	try "$1"
else
	try brew
	try npm
	try tlmgr
fi
