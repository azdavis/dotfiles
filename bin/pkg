#!/usr/bin/env zsh

source "$HOME/.config/etc/base.sh" || exit 1

cd "$HOME/.config/pkg"

get "do_brew"
get "do_gem"
get "do_tlmgr"

if [[ "$do_brew" == "y" ]]; then
    which brew > /dev/null || curl -fsSL "https://git.io/pVOl" | ruby
    brew update
    brew upgrade
    formula="$(brew --prefix)/Library/Formula"
    cd "$formula"
    git apply "$HOME/.config/etc/coreutils-remove-g-prefix.patch"
    cd "$HOME/.config/pkg"
    brew bundle --verbose
    cd "$formula"
    git checkout "coreutils.rb"
    cd "$HOME/.config/pkg"
    brew bundle cleanup --force
    brew cask cleanup --force
    brew cleanup --force
    brew prune
    brew doctor || true
fi

if [[ "$do_gem" == "y" ]]; then
    gem install bundle
    bundle install
    bundle update
    rm -rf "$HOME/.gem" "$HOME/.bundle" ".bundle" "Gemfile.lock"
fi

if [[ "$do_tlmgr" == "y" ]]; then
    tlmgr update --self
    tlmgr update --all
    tlmgr install $(cat tlmgrfile)
fi

true
