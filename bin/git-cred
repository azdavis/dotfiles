#!/bin/sh

c="add"
H="github.com"
p=""
P="https"
u="$LOGNAME"

usage() {
cat <<EOF >&2
usage:
    $(basename "$0") [options]

options:
    -h
        show this help
    -c (show | add | rm)
        use the given command (default: $c)
    -H <host>
        use the host <host> (default: $H)
    -p <password>
        use the password <password> (should only be used with -c add)
    -P <protocol>
        use the protocol <protocol> (default: $P)
    -u <username>
        use the username <username> (default: $u)
EOF
exit 1
}

while getopts "hc:H:p:P:u:" opt; do
    case "$opt" in
    (c) c="$OPTARG" ;;
    (H) H="$OPTARG" ;;
    (p) p="$OPTARG" ;;
    (P) P="$OPTARG" ;;
    (u) u="$OPTARG" ;;
    (*) usage ;;
    esac
done
shift $((OPTIND - 1))

if [ $# -ne 0 ]; then
    usage
fi

git_cmd=""
git_str="$(printf 'host=%s\nprotocol=%s\nusername=%s' "$H" "$P" "$u")"
if [ "$c" = "add" ]; then
    if [ -z "$p" ]; then
        usage
    fi
    git_cmd="approve"
    git_str="$git_str$(printf '\npassword=%s' "$p")"
else
    if [ -n "$p" ]; then
        usage
    fi
    case "$c" in
    (show) git_cmd="fill" ;;
    (rm) git_cmd="reject" ;;
    (*) usage ;;
    esac
fi

echo "$git_str" | git credential "$git_cmd"
