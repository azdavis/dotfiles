#!/bin/sh

c="add"
H=""
p=""
P="https"
u="$LOGNAME"

usage() {
cat <<EOF >&2
usage: $(basename "$0") [options]

options:
	-c (show | add | rm)
		use the given command (default: add)
	-h
		show this help
	-H <host>
		use the host <host>
	-p <password>
		use the password <password> (should only be used with -c add)
	-P <protocol>
		use the protocol <protocol> (default: $P)
	-u <username>
		use the username <username> (default: $u)
EOF
exit 1
}

while getopts "c:hH:p:P:u:" opt; do
	case "$opt" in
	(c) c="$OPTARG" ;;
	(H) H="$OPTARG" ;;
	(p) p="$OPTARG" ;;
	(P) P="$OPTARG" ;;
	(u) u="$OPTARG" ;;
	(*) usage ;;
	esac
done
shift $((OPTIND - 1))

if [ $# -ne 0 ] || [ -z "$H" ]; then
	usage
fi

git_cmd=""
git_str="$(printf 'host=%s\nprotocol=%s\nusername=%s\n' "$H" "$P" "$u")"
if [ "$c" = "add" ]; then
	if [ -z "$p" ]; then
		usage
	fi
	git_str="$git_str$(printf 'password=%s\n' "$p")"
	git_cmd="approve"
else
	if [ -n "$p" ]; then
		usage
	fi
	case "$c" in
	(show) git_cmd="fill" ;;
	(rm) git_cmd="reject" ;;
	(*) usage ;;
	esac
fi

printf '%s' "$git_str" | git credential "$git_cmd"
