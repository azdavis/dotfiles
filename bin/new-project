#!/bin/sh

. "$HOME/.config/lib/base.sh"
. "$HOME/.config/lib/abort.sh"

usage() {
    abort "usage: $(basename "$0") [-t type] <name> <description>"
}

t=""
while getopts t: opt; do
    case "$opt" in
    (t) t="$OPTARG" ;;
    (?) usage ;;
    esac
done
shift "$(expr "$OPTIND" - 1)"

if [ $# -ne 2 ]; then
    usage
fi

if ! name="$(git config --global user.name)"; then
    abort "no git user.name found"
fi
if ! email="$(git config --global user.email)"; then
    abort "no git user.email found"
fi

templates="$HOME/.config/templates"
proj="$1"
path="$PWD/$proj"
desc="$2"
year="$(date +%Y)"

gh_password="$( \
    echo hostname=github.com \
        | git credential-store get \
        | grep password \
        | sed "s/password=//g" \
)"

if [ -e "$proj" ]; then
    abort "'$proj' already exists"
fi

if ! [ -d "$templates/$t" ]; then
    abort "invalid type: '$t'"
fi

replace() {
    cat \
        | sed "s/{{desc}}/$desc/g" \
        | sed "s/{{proj}}/$proj/g" \
        | sed "s/{{name}}/$name/g" \
        | sed "s/{{email}}/$email/g" \
        | sed "s/{{year}}/$year/g"
}

dst_name() {
    echo "$path/$1" | replace
}

add_dir() {
    b="$(basename "$1")"
    if [ "$b" = . ] || [ "$b" = .. ]; then
        return
    fi
    mkdir -p "$(dst_name "$1")"
    add "$1"
}

add_file() {
    cat "$1" | replace >> "$(dst_name "$1")"
}

add() {
    for x in "$1"/* "$1"/.*; do
        if [ -d "$x" ]; then
            add_dir "$x"
        else
            add_file "$x"
        fi
    done
}

add_template() {
    echo "adding template '$1'"
    cd "$templates/$1"
    add .
}


echo "creating '$proj'"
mkdir -p "$path/src"
add_template base
if [ -n "$t" ]; then
    add_template "$t"
fi

cd "$path"
sort -o .gitignore .gitignore

echo "creating local git repository"
git init -q
git remote add origin "https://github.com/$name/$proj.git"
git add -A
git commit -q -m "start project"

echo "creating remote github repository"
curl \
    -s \
    -H "Accept: application/vnd.github.v3+json" \
    -H "Content-Type: application/json" \
    -H "Authorization: token $gh_password" \
    -X POST \
    -d "{\"name\":\"$proj\",\"description\":\"$desc\"}" \
    "https://api.github.com/user/repos" \
    > /dev/null
git push -q -u origin master > /dev/null
