#!/bin/sh

. "$HOME/.config/lib/base.sh"
. "$HOME/.config/lib/abort.sh"

usage() {
    echo "usage: $(basename "$0") [-t type] <name> <description>"
    exit 1
}

t=""
while getopts t: opt; do
    case "$opt" in
    (t) t="$OPTARG" ;;
    (?) usage ;;
    esac
done
shift "$(expr "$OPTIND" - 1)"

if [ $# -ne 2 ]; then
    usage
fi

templates="$HOME/.config/templates"
relative_name="$1"
absolute_name="$PWD/$relative_name"
description="$2"
year="$(date +%Y)"

if [ -e "$relative_name" ]; then
    abort "'$relative_name' already exists"
fi

if ! [ -d "$templates/$t" ]; then
    abort "invalid type: '$t'"
fi

replace() {
    cat \
        | sed "s/{{name}}/$relative_name/g" \
        | sed "s/{{description}}/$description/g" \
        | sed "s/{{year}}/$year/g"
}

add_dir() {
    b="$(basename "$1")"
    if [ "$b" = . ] || [ "$b" = .. ]; then
        return
    fi
    mkdir -p "$absolute_name/$1"
    add "$1"
}

add_file() {
    cat "$1" | replace >> "$absolute_name/$1"
}

add() {
    for x in "$1"/* "$1"/.*; do
        if [ -d "$x" ]; then
            add_dir "$x"
        else
            add_file "$x"
        fi
    done
}

add_template() {
    cd "$templates/$1"
    add .
}

mkdir -p "$absolute_name/src"
git -C "$absolute_name" init -q
add_template base
if [ -n "$t" ]; then
    add_template "$t"
fi

sort -o "$absolute_name/.gitignore" "$absolute_name/.gitignore"
