#!/usr/bin/env zsh

source "$HOME/.config/misc/base.sh" || exit 1

rm_file() {
    [[ ! -e "$1" || -h "$1" ]] && return 0
    echo -n "rm $1 [yn]? " && read x
    [[ "$x" == 'y' ]] && rm -rf "$1"
}

sym() {
    rm_file "$2"
    ln -fsn "$1" "$2"
}

if pgrep -f 'Sublime Text' > /dev/null; then
    abort 'sublime text must not be running'
fi

support="$HOME/Library/Application Support/Sublime Text 3"
pkg_ctrl_file="$HOME/.config/subl/Package Control"
pkg_ctrl_exist=false
[[ -e "$pkg_ctrl_file.sublime-settings" ]] && pkg_ctrl_exist=true
mkdir -p "$support/Packages"

rm_file "$pkg_ctrl_file.cache"
rm_file "$support/Cache"
rm_file "$support/Local/Session.sublime_session"
rm_file "$support/Local/Auto Save Session.sublime_session"
sym "$HOME/.config/subl" "$support/Packages/User"

sym \
    '/Applications/Sublime Text.app/Contents/SharedSupport/bin/subl' \
    '/usr/local/bin/edit'

if ! $pkg_ctrl_exist; then
    echo -n 'install package control [yn]? ' && read x
    [[ "$x" == 'y' ]] && open 'https://packagecontrol.io/installation'
fi

true
