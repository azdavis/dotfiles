#!/usr/bin/env zsh

source "$HOME/.config/misc/base.sh" || exit 1

rm_irf() {
  [[ -e "$1" || -h "$1" ]] || return 0
  echo -n "destroy $1 [yn]? " && read x
  [[ "$x" == 'y' ]] && rm -rf "$1"
}

if pgrep -f 'Sublime Text' > /dev/null; then
  err 'sublime text must not be running'
fi

support="$HOME/Library/Application Support/Sublime Text 3"
app='/Applications/Sublime Text.app/Contents'

mkdir -p "$support/Packages"
rm_irf "$support/Cache"
rm_irf "$support/Local/Session.sublime_session"
rm_irf "$support/Local/Auto Save Session.sublime_session"

cd "$HOME/.config/subl"
for f in *; do
  rm_irf "$support/Packages/$f"
  ln -s "$HOME/.config/subl/$f" "$support/Packages"
done

rm_irf '/usr/local/bin/edit'
ln -s "$app/SharedSupport/bin/subl" '/usr/local/bin/edit'

echo -n 'install package control [yn]? ' && read x
[[ "$x" == 'y' ]] && open 'https://packagecontrol.io/installation'
